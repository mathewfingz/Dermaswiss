<div class="monthly-calendar container section-{{ section.id }}">
  <div class="calendar-header">
    <h2 class="h2">{{ section.settings.heading | default: 'Monthly Calendar' }}</h2>
    <div class="calendar-nav">
      <button id="prevMonth" class="btn btn--secondary btn--small">
        {% render 'icon-arrow-left' %}
      </button>
      <h3 id="currentMonthYear" class="h4"></h3>
      <button id="nextMonth" class="btn btn--secondary btn--small">
        {% render 'icon-arrow-right' %}
      </button>
    </div>
  </div>
  <div class="calendar-body">
    <div class="calendar-weekdays">
      <div>Dom</div>
      <div>Lun</div>
      <div>Mar</div>
      <div>Mié</div>
      <div>Jue</div>
      <div>Vie</div>
      <div>Sáb</div>
    </div>
    <div id="calendarDays" class="calendar-days"></div>
  </div>
</div>

<script>
  window.calendarEvents = {
    {% for block in section.blocks %}
      "{{ block.settings.event_date }}": [
        {% assign same_date_events = section.blocks | where: "settings.event_date", block.settings.event_date %}
        {% for event in same_date_events %}
          {
            "title": {{ event.settings.title | json }},
            "color": "{{ event.settings.event_color }}"
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]{% unless forloop.last %},{% endunless %}
    {% endfor %}
  };

  document.addEventListener('DOMContentLoaded', function() {
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthYear = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');

    let currentDate = new Date();

    function renderCalendar(date) {
      calendarDays.innerHTML = '';
      const year = date.getFullYear();
      const month = date.getMonth();

      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
      ];

      currentMonthYear.innerText = `${monthNames[month]} ${year}`;

      // Days from previous month
      for (let i = 0; i < firstDayOfMonth; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('calendar-day', 'empty');
        calendarDays.appendChild(emptyDay);
      }

      // Actual days
      for (let day = 1; day <= lastDayOfMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('calendar-day');
        
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        dayElement.setAttribute('data-date', dateString);

        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
          dayElement.classList.add('today');
        }

        let dayContent = `<span class="day-number">${day}</span><div class="events-container">`;
        
        // Render events for this day
        if (window.calendarEvents && window.calendarEvents[dateString]) {
          // Use a Set to avoid duplicates if multiple events exist for the same day (Liquid logic above might repeat them)
          const uniqueEvents = [];
          const seenTitles = new Set();
          window.calendarEvents[dateString].forEach(event => {
            if (!seenTitles.has(event.title)) {
              uniqueEvents.push(event);
              seenTitles.add(event.title);
            }
          });

          uniqueEvents.forEach(event => {
            dayContent += `
              <div class="calendar-event" style="background-color: ${event.color};">
                <span class="event-title">${event.title}</span>
              </div>
            `;
          });
        }
        
        dayContent += `</div>`;
        dayElement.innerHTML = dayContent;
        calendarDays.appendChild(dayElement);
      }
    }

    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    });

    // Listen for Shopify editor events
    document.addEventListener('shopify:section:load', () => renderCalendar(currentDate));

    renderCalendar(currentDate);
  });
</script>

<style>
  .monthly-calendar {
    margin-top: 40px;
    margin-bottom: 40px;
  }
  .calendar-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
  }
  .calendar-nav {
    display: flex;
    align-items: center;
    gap: 30px;
  }
  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: bold;
    background: #f4f4f4;
    padding: 10px 0;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
  }
  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    border-left: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
  }
  .calendar-day {
    min-height: 120px;
    padding: 10px;
    border-right: 1px solid #ddd;
    border-top: 1px solid #ddd;
    position: relative;
    background: #fff;
    display: flex;
    flex-direction: column;
  }
  .calendar-day.empty {
    background: #fafafa;
  }
  .calendar-day.today {
    background: #fff9e6;
  }
  .day-number {
    font-weight: bold;
    margin-bottom: 8px;
    display: block;
    font-size: 1.2rem;
  }
  .events-container {
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow-y: auto;
  }
  .calendar-event {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 3px;
    color: #000;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-left: 3px solid rgba(0,0,0,0.2);
  }
  @media (max-width: 767px) {
    .calendar-day {
      min-height: 80px;
      padding: 5px;
    }
    .day-number {
      font-size: 1rem;
    }
    .calendar-event {
      font-size: 9px;
      padding: 1px 3px;
    }
  }
</style>

{% schema %}
{
  "name": "Monthly Calendar",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Calendario Mensual"
    }
  ],
  "blocks": [
    {
      "type": "event",
      "name": "Evento",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Título del Evento",
          "default": "Nuevo Evento"
        },
        {
          "type": "text",
          "id": "event_date",
          "label": "Fecha (YYYY-MM-DD)",
          "info": "Ejemplo: 2025-12-25",
          "default": "2025-12-25"
        },
        {
          "type": "color",
          "id": "event_color",
          "label": "Color de etiqueta",
          "default": "#e6f3ff"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Monthly Calendar",
      "blocks": [
        {
          "type": "event",
          "settings": {
            "title": "Evento de ejemplo",
            "event_date": "2025-12-25"
          }
        }
      ]
    }
  ]
}
{% endschema %}
